Description: CVE-2016-6153 - insecure tmpfile generation.
 See https://korelogic.com/Resources/Advisories/KL-001-2016-003.txt
 for details of the vulnerabilty.
 This is the backport to sqlite v2 of the commits mentioned in Origin
Author: Tobias Frost <tobi@debian.org>
Origin: https://www.sqlite.org/cgi/src/info/67985761aa93fb61
Origin: https://www.sqlite.org/cgi/src/info/b38fe522cfc971b3
Forwarded: not-needed, software is EOL.
Last-Update: 2023-05-13 <YYYY-MM-DD, last update of the meta-information, optional>
---
This patch header follows DEP-3: http://dep.debian.net/deps/dep3/
--- a/src/os.c
+++ b/src/os.c
@@ -804,16 +804,22 @@
     "0123456789";
   int i, j;
   struct stat buf;
-  const char *zDir = ".";
+  const char *zDir = NULL;
   azDirs[0] = sqlite_temp_directory;
-  for(i=0; i<sizeof(azDirs)/sizeof(azDirs[0]); i++){
+  for(i=0; i<=sizeof(azDirs)/sizeof(azDirs[0]); i++){
     if( azDirs[i]==0 ) continue;
     if( stat(azDirs[i], &buf) ) continue;
     if( !S_ISDIR(buf.st_mode) ) continue;
-    if( access(azDirs[i], 07) ) continue;
+    if( access(azDirs[i], 03) ) continue;
     zDir = azDirs[i];
     break;
   }
+
+  // CVE-2016-6153: if "." (last fallback option) is unsafe, fake IOERR.
+  if(zDir == NULL) {
+	  return SQLITE_IOERR;
+  }
+
   do{
     sprintf(zBuf, "%s/"TEMP_FILE_PREFIX, zDir);
     j = strlen(zBuf);
--- a/src/pager.c
+++ b/src/pager.c
@@ -897,8 +897,10 @@
   int rc;
   do{
     cnt--;
-    sqliteOsTempFileName(zFile);
-    rc = sqliteOsOpenExclusive(zFile, fd, 1);
+    rc = sqliteOsTempFileName(zFile);
+    if(rc == SQLITE_OK) {
+        rc = sqliteOsOpenExclusive(zFile, fd, 1);
+    }
   }while( cnt>0 && rc!=SQLITE_OK );
   return rc;
 }
